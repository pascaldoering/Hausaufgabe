<!DOCTYPE html>
<html>
<head>
<script type="text/javascript" src="js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
<style>
#footer {
	width: 100%;
	height: 1.5em;
	color: white;
	text-align: center;
	position: fixed;
	z-index: 100;
	bottom: 0px;
	left: 0px;
	cursor: pointer;
	transition: all 0.6s ease-in-out;
}
#blog-card{
display: none;
}
</style>
<meta charset="UTF-8">
<title>Hausaufgabe</title>
</head>
<body class="bg-light">
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand">Hausaufgabe</a>
  </div>
</nav>
	<main id="main" style="margin-bottom: .5em; margin-top: 2em; text-align: center">
		<div class="d-flex">
		<div class="col-1">
		</div>
		
		<div class="col-10" id="content">
			<div id="introduction">
				<div class="card">
					<div class="card-header h3"  id="card-header" >Aufgabe</div>
					<div class="card-body text-start" id="card-body">
						<p>Erstelle ein Full Stack System Frontend / Backend mit folgender Aufgabestellung:</p>
						<p>1. Das Backend ruft zyklisch (alle paar Sekunden) die Blogbeitr&auml;ge von der Seite internate.org ab (&uuml;ber die Wordpress API - https://developer.wordpress.org/rest-api/reference/posts/)</p>
						<p>2. Das Backend verarbeitet die Blogbeitr&auml;ge zu einer einfachen Word Count Map ({&Prime;und&Prime;: 5, &Prime;der&Prime;: 3, ...})</p>
						<p>3. Das Backend sendet nach der Verarbeitung die Map per WebSocket an das Frontend</p>
						<p>4. Das Frontend zeigt die neuen Beitr&auml;ge an und aktualisiert sich selbstst&auml;ndig neu bei neuen Daten.</p>
					</div>
				</div>		
				<br/>
			</div>
			<div id="blog-card">
					<div class="card">
						  <div class="card-header text-decoration-none "  id="card-header" >&emsp;</div>
						  <div class="card-body text-break" id="card-body"></div>
					</div>		
					<br/>
			</div>
		</div>

		<div class="col-1">
		</div>
		</div>
	</main>
</body>

<footer id="footer" class="bg-dark"> &#169; Pascal D&ouml;ring 2022 </footer>

<script>

var ids = [];
var displayedIds = [];
var counter = 1;
var interval = 0;

function intervalGetData() {
	console.log('intervalGetData()');
 	getData();
}

function getData() {
	console.log('getData()');
	
	
	var bar = new Promise((resolve, reject) => {
		$.post("InternateAbfrage", '', function(data) {
			data.forEach(function(id) {
				if(!ids.includes(id)) ids.push(id);
				if(data.indexOf(id) == data.length-1) {
					resolve();
				}
			});
		});
	});

	bar.then(() => {
		processID();
	});
}

function processID() {
	console.log('processID()');
	
	var wait = new Promise((resolve, reject) => {
		ids.forEach(function(id) {
			$.post("InternateAbfrageBeitrag", 'ID='+id, function(blog) {
				if(blog != null && blog != '' && !displayedIds.includes(id)) {
					
					let blogcard = document.getElementById('blog-card');
					let cloned = blogcard.cloneNode(true);
					cloned.id = cloned.id + counter;
					
					let cheader = cloned.querySelector('#card-header');
					cheader.id = cheader.id + counter;
					cheader.innerHTML += 'Blogeintrag mit der ID : '+id;
					
					let cbody = cloned.querySelector('#card-body');
					cbody.id = cbody.id + counter;
					cbody.innerHTML = blog;
					
					let content = document.getElementById('content');
					
					content.appendChild(cloned);
					
					displayedIds.push(id);
					
					counter++;
				}
				
			});
			if(ids.indexOf(id) == ids.length-1) {
				resolve();
			}
		});
	});

	wait.then(() => {
		if(interval == 0) {
			interval = 5000;													//Interval in welchem die IDs der Blogeintraege abgefragt werden soll
			console.log('setInterval 10000');									//Interval in welchem die IDs der Blogeintraege abgefragt werden soll
			var intervalID = window.setInterval(intervalGetData, interval);		//Interval in welchem die IDs der Blogeintraege abgefragt werden soll
		}
	});
}

$(document).ready(function() {
	getData();
});
</script>
</html>